<!-- Modal Backdrop -->
<div *ngIf="isOpen" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" (click)="onBackdropClick($event)">
  <!-- Modal Container -->
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="flex items-center justify-between p-6 border-b">
      <h2 class="text-xl font-semibold text-gray-800">Importar Factura desde XML</h2>
      <button
        type="button"
        (click)="close()"
        class="text-gray-400 hover:text-gray-600 transition-colors"
        [disabled]="isLoading">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6 space-y-4">
      <!-- Error Message -->
      <div *ngIf="errorMessage" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md">
        <p class="text-sm">{{ errorMessage }}</p>
      </div>

      <!-- File Upload -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Archivo XML <span class="text-red-500">*</span>
        </label>
        <div class="flex items-center space-x-3">
          <label class="flex-1 flex items-center justify-center px-4 py-3 border-2 border-dashed border-gray-300 rounded-md cursor-pointer hover:border-blue-500 transition-colors">
            <input
              type="file"
              accept=".xml"
              (change)="onFileSelected($event)"
              class="hidden"
              [disabled]="isLoading">
            <div class="flex items-center space-x-2">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              <span class="text-sm text-gray-600">
                {{ selectedFile ? selectedFile.name : 'Seleccionar archivo' }}
              </span>
            </div>
          </label>
        </div>
        <p class="text-xs text-gray-500 mt-1">Formato: XML | Tamaño máximo: 5MB</p>
      </div>

      <!-- Trip Selection -->
      <div>
        <label for="tripId" class="block text-sm font-medium text-gray-700 mb-2">
          Viaje Asociado (opcional)
        </label>
        <select
          id="tripId"
          [(ngModel)]="uploadData.tripId"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          [disabled]="isLoading">
          <option [ngValue]="undefined">Sin viaje asociado</option>
          <option *ngFor="let trip of trips" [ngValue]="trip.id">
            {{ trip.origin }} → {{ trip.destination }} - {{ trip.startDate | date:'dd/MM/yyyy' }}
          </option>
        </select>
      </div>

      <!-- Accounting Period -->
      <div>
        <label for="accountingPeriod" class="block text-sm font-medium text-gray-700 mb-2">
          Período Contable (opcional)
          <span class="inline-flex items-center ml-1 relative group">
            <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="invisible group-hover:visible absolute bottom-full left-0 mb-2 w-64 p-2 bg-gray-800 text-white text-xs rounded shadow-lg z-10">
              Por defecto se usa el mes de la fecha de emisión del XML. Puedes cambiarlo manualmente si la factura debe pertenecer a otro período contable (ej: facturas con acuse de recibo en mes diferente).
              <div class="absolute top-full left-4 -mt-1 border-4 border-transparent border-t-gray-800"></div>
            </div>
          </span>
        </label>
        <input
          type="month"
          id="accountingPeriod"
          [(ngModel)]="uploadData.accountingPeriod"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          [disabled]="isLoading"
          title="Si no se especifica, se usará el mes de la fecha de emisión">
        <p class="text-xs text-gray-500 mt-1">
          Si no se especifica, se usará automáticamente el mes de la fecha de emisión del XML
        </p>
      </div>

      <!-- Notes -->
      <div>
        <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
          Notas (opcional)
        </label>
        <textarea
          id="notes"
          [(ngModel)]="uploadData.notes"
          rows="3"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
          placeholder="Agregar notas adicionales..."
          [disabled]="isLoading">
        </textarea>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="flex items-center justify-end gap-3 p-6 border-t bg-gray-50">
      <button
        type="button"
        (click)="close()"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
        [disabled]="isLoading">
        Cancelar
      </button>
      <button
        type="button"
        (click)="onSubmit()"
        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
        [disabled]="isLoading || !selectedFile">
        <svg *ngIf="isLoading" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>{{ isLoading ? 'Procesando...' : 'Importar' }}</span>
      </button>
    </div>
  </div>
</div>
