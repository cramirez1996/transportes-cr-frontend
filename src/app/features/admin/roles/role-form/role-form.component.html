<form [formGroup]="roleForm" (ngSubmit)="onSubmit()" class="space-y-6">
  <!-- Basic Info -->
  <div class="space-y-4">
    <h3 class="text-lg font-semibold text-gray-900">Información Básica</h3>

    <!-- Name (technical) -->
    <div>
      <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
        Nombre Técnico *
      </label>
      <input
        type="text"
        id="name"
        formControlName="name"
        placeholder="ej: custom_manager"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
        [class.border-red-500]="roleForm.get('name')?.invalid && roleForm.get('name')?.touched"
      />
      @if (role) {
        <p class="text-xs text-gray-500 mt-1">El nombre técnico no puede ser modificado</p>
      }
      @if (getErrorMessage('name')) {
        <p class="text-red-500 text-xs mt-1">{{ getErrorMessage('name') }}</p>
      }
    </div>

    <!-- Display Name -->
    <div>
      <label for="displayName" class="block text-sm font-medium text-gray-700 mb-1">
        Nombre para Mostrar *
      </label>
      <input
        type="text"
        id="displayName"
        formControlName="displayName"
        placeholder="ej: Gerente Personalizado"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        [class.border-red-500]="roleForm.get('displayName')?.invalid && roleForm.get('displayName')?.touched"
      />
      @if (getErrorMessage('displayName')) {
        <p class="text-red-500 text-xs mt-1">{{ getErrorMessage('displayName') }}</p>
      }
    </div>

    <!-- Description -->
    <div>
      <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
        Descripción
      </label>
      <textarea
        id="description"
        formControlName="description"
        rows="3"
        placeholder="Describe las responsabilidades de este rol..."
        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      ></textarea>
    </div>
  </div>

  <!-- Permissions Selection -->
  <div class="space-y-4">
    <div class="flex justify-between items-center">
      <h3 class="text-lg font-semibold text-gray-900">Permisos</h3>
      <span class="text-sm text-gray-500">{{ selectedPermissionIds().size }} seleccionados</span>
    </div>

    @if (loading()) {
      <div class="flex justify-center items-center py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    }

    @if (!loading()) {
      <div class="border border-gray-200 rounded-lg divide-y divide-gray-200 max-h-96 overflow-y-auto">
        @for (resource of getResourceKeys(); track resource) {
          <div class="p-4">
            <!-- Resource Header -->
            <div class="flex items-center mb-3">
              <input
                type="checkbox"
                [id]="'resource-' + resource"
                [checked]="isResourceFullySelected(resource)"
                [indeterminate]="isResourcePartiallySelected(resource)"
                (change)="toggleResource(resource)"
                class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
              />
              <label
                [for]="'resource-' + resource"
                class="ml-3 text-sm font-semibold text-gray-900 cursor-pointer"
              >
                {{ getResourceDisplayName(resource) }}
              </label>
            </div>

            <!-- Permissions in this resource -->
            <div class="ml-7 space-y-2">
              @for (permission of groupedPermissions()[resource]; track permission.id) {
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    [id]="'permission-' + permission.id"
                    [checked]="isPermissionSelected(permission.id)"
                    (change)="togglePermission(permission.id)"
                    class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-0.5"
                  />
                  <div class="ml-3">
                    <label
                      [for]="'permission-' + permission.id"
                      class="text-sm text-gray-700 cursor-pointer"
                    >
                      <span class="font-medium">{{ getActionDisplayName(permission.action) }}</span>
                      <span class="text-gray-500 ml-1">({{ permission.name }})</span>
                    </label>
                    @if (permission.description) {
                      <p class="text-xs text-gray-500">{{ permission.description }}</p>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>

      @if (selectedPermissionIds().size === 0) {
        <p class="text-sm text-red-600">Debes seleccionar al menos un permiso</p>
      }
    }
  </div>

  <!-- Actions -->
  <div class="flex justify-end gap-3 pt-4 border-t">
    <button
      type="button"
      (click)="onCancel()"
      class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
    >
      Cancelar
    </button>
    <button
      type="submit"
      [disabled]="!roleForm.valid || selectedPermissionIds().size === 0 || loading()"
      class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
    >
      {{ role ? 'Actualizar' : 'Crear' }} Rol
    </button>
  </div>
</form>
