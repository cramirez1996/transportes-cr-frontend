<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Explorador de Transacciones</h1>
    <p class="mt-2 text-gray-600">
      Análisis multidimensional de ingresos y gastos
    </p>
  </div>

  <!-- Metric Cards -->
  <div class="mb-8">
    <app-metric-cards
      [cards]="metricCards"
      [loading]="isLoadingMetrics"
    ></app-metric-cards>
  </div>

  <!-- Main Layout: Chart + Table | Filters -->
  <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
    <!-- Left Column: Chart + Breakdown (9/12) -->
    <div class="xl:col-span-9 space-y-6">
      <!-- Chart Section -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Tendencia Temporal</h2>
        <app-chart-section
          [timeSeriesData]="timeSeriesData"
          [groupedTimeSeriesData]="groupedTimeSeriesData"
          [loading]="isLoadingChart"
        ></app-chart-section>
      </div>

      <!-- Breakdown Table -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
          <h2 class="text-xl font-semibold text-gray-900">
            Desglose por {{ getDimensionLabel(filters.groupBy) }}
          </h2>
        </div>

        <app-breakdown-table
          [data]="aggregateData"
          [loading]="isLoadingBreakdown"
          [dimension]="filters.groupBy"
        ></app-breakdown-table>
      </div>
    </div>

    <!-- Right Column: Filters (3/12) -->
    <div class="xl:col-span-3">
      <div class="bg-white rounded-lg shadow p-6 sticky top-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Filtros</h3>

        <!-- Reactive Form -->
        <form [formGroup]="filtersForm">
          <!-- Periodo (Preset) -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
            <select
              formControlName="preset"
              (change)="onPresetChange()"
              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="last7days">Últimos 7 días</option>
              <option value="last30days">Últimos 30 días</option>
              <option value="last90days">Últimos 90 días</option>
              <option value="thisMonth">Este mes</option>
              <option value="lastMonth">Mes anterior</option>
              <option value="thisYear">Este año</option>
              <option value="custom">Personalizado</option>
            </select>
          </div>

          <!-- Fecha Desde -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Desde</label>
            <input
              type="date"
              formControlName="startDate"
              (change)="onCustomDateChange()"
              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <!-- Fecha Hasta -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Hasta</label>
            <input
              type="date"
              formControlName="endDate"
              (change)="onCustomDateChange()"
              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <!-- Comparar Periodo -->
          <div class="mb-6 pb-6 border-b border-gray-200">
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                formControlName="compareEnabled"
                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
              />
              <span class="text-sm font-medium text-gray-700">Comparar período</span>
            </label>
            <p *ngIf="filtersForm.get('compareEnabled')?.value" class="mt-2 text-xs text-blue-600">
              Se comparará con el período anterior de igual duración
            </p>
          </div>

          <!-- Group By Selector -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Agrupar por</label>
            <select
              formControlName="groupBy"
              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="category">Categoría</option>
              <option value="type">Tipo</option>
              <option value="paymentMethod">Método de Pago</option>
              <option value="vehicle">Vehículo</option>
              <option value="driver">Conductor</option>
              <option value="customer">Cliente</option>
              <option value="supplier">Proveedor</option>
            </select>
          </div>

          <!-- Granularity Selector -->
          <div class="mb-6 pb-6 border-b border-gray-200">
            <label class="block text-sm font-medium text-gray-700 mb-2">Granularidad</label>
            <select
              formControlName="granularity"
              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="day">Diaria</option>
              <option value="week">Semanal</option>
              <option value="month">Mensual</option>
              <option value="year">Anual</option>
            </select>
          </div>

          <!-- Advanced Filters Toggle -->
          <button
            type="button"
            (click)="toggleFilters()"
            class="w-full flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-50 border border-gray-300 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors mb-4"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
            </svg>
            <span>{{ showFilters ? 'Ocultar' : 'Mostrar' }} Filtros Avanzados</span>
          </button>

          <!-- Advanced Filters (Vertical Layout) -->
          <div *ngIf="showFilters" class="space-y-4">
            <!-- Type filter -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Tipo de Transacción
              </label>
              <select
                formControlName="type"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="all">Todos</option>
                <option value="INCOME">Ingresos</option>
                <option value="EXPENSE">Gastos</option>
              </select>
            </div>

            <!-- Payment method filter -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Método de Pago
              </label>
              <select
                formControlName="paymentMethod"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="all">Todos</option>
                <option value="CASH">Efectivo</option>
                <option value="TRANSFER">Transferencia</option>
                <option value="CHECK">Cheque</option>
                <option value="CARD">Tarjeta</option>
              </select>
            </div>

            <!-- Multi-select filters (compact) -->
            <div class="space-y-3">
              <!-- Categories -->
              <app-entity-multi-select
                entityType="categories"
                label="Categorías"
                placeholder="Buscar categorías..."
                [(selectedIds)]="selectedCategoryIds"
                (selectedIdsChange)="filtersForm.patchValue({ categoryIds: selectedCategoryIds })"
              ></app-entity-multi-select>

              <!-- Vehicles -->
              <app-entity-multi-select
                entityType="vehicles"
                label="Vehículos"
                placeholder="Buscar vehículos..."
                [(selectedIds)]="selectedVehicleIds"
                (selectedIdsChange)="filtersForm.patchValue({ vehicleIds: selectedVehicleIds })"
              ></app-entity-multi-select>

              <!-- Drivers -->
              <app-entity-multi-select
                entityType="drivers"
                label="Conductores"
                placeholder="Buscar conductores..."
                [(selectedIds)]="selectedDriverIds"
                (selectedIdsChange)="filtersForm.patchValue({ driverIds: selectedDriverIds })"
              ></app-entity-multi-select>

              <!-- Customers -->
              <app-entity-multi-select
                entityType="customers"
                label="Clientes"
                placeholder="Buscar clientes..."
                [(selectedIds)]="selectedCustomerIds"
                (selectedIdsChange)="filtersForm.patchValue({ customerIds: selectedCustomerIds })"
              ></app-entity-multi-select>

              <!-- Suppliers -->
              <app-entity-multi-select
                entityType="suppliers"
                label="Proveedores"
                placeholder="Buscar proveedores..."
                [(selectedIds)]="selectedSupplierIds"
                (selectedIdsChange)="filtersForm.patchValue({ supplierIds: selectedSupplierIds })"
              ></app-entity-multi-select>
            </div>

            <!-- Action buttons -->
            <div class="pt-4 flex flex-col gap-2">
              <button
                type="button"
                (click)="resetAdvancedFilters()"
                class="w-full px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                Limpiar Filtros
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
